<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Results - Library Media Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .back-btn {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .summary h2 {
            margin-bottom: 10px;
        }

        .query-section {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .query-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .query-input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #667eea;
            border-radius: 25px;
            font-size: 1em;
            outline: none;
        }

        .query-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .query-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .query-result {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
            display: none;
        }

        .query-result.show {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }

        .tab:hover {
            color: #764ba2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .data-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .data-item {
            background: #f8f9ff;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .data-label {
            font-weight: bold;
            color: #333;
        }

        .data-value {
            color: #666;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .badge-adult {
            background: #d4edda;
            color: #155724;
        }

        .badge-child {
            background: #cce5ff;
            color: #004085;
        }

        .badge-high {
            background: #d4edda;
            color: #155724;
        }

        .badge-medium {
            background: #fff3cd;
            color: #856404;
        }

        .processing {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .timestamp {
            color: #764ba2;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div class="container">
    <a href="/" class="back-btn">‚Üê Back to Upload</a>

    <div class="header">
        <h1 th:text="${result.fileName}">Analysis Results</h1>
    </div>

    <div class="card" th:if="${result.status == 'PROCESSING'}">
        <div class="processing">
            <div class="spinner"></div>
            <h2>Processing Your File...</h2>
            <p>This may take a few moments. Please refresh the page.</p>
        </div>
    </div>

    <div th:if="${result.status == 'COMPLETED'}">
        <div class="card">
            <div class="summary">
                <h2>Summary</h2>
                <p th:text="${result.summary}"></p>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" th:text="${#lists.size(result.detectedPeople)}">0</div>
                    <div class="stat-label">People Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${#lists.size(result.detectedObjects)}">0</div>
                    <div class="stat-label">Objects Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" th:text="${#lists.size(result.detectedBooks)}">0</div>
                    <div class="stat-label">Books Detected</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="query-section">
                <h3>üîç Ask Questions About Your Media</h3>
                <p style="margin-bottom: 15px; color: #666;">
                    Try: "Is anyone drinking coffee?", "Are there any children?", "Show me all books"
                </p>
                <div class="query-input-group">
                    <input type="text" id="queryInput" class="query-input"
                           placeholder="Ask a question about your media...">
                    <button onclick="processQuery()" class="query-btn">Search</button>
                </div>
                <div id="queryResult" class="query-result"></div>
            </div>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="showTab('people')">
                    üë• People (<span th:text="${#lists.size(result.detectedPeople)}">0</span>)
                </button>
                <button class="tab" onclick="showTab('objects')">
                    üì¶ Objects (<span th:text="${#lists.size(result.detectedObjects)}">0</span>)
                </button>
                <button class="tab" onclick="showTab('books')">
                    üìö Books (<span th:text="${#lists.size(result.detectedBooks)}">0</span>)
                </button>
            </div>

            <div id="people" class="tab-content active">
                <div class="data-list">
                    <div th:if="${#lists.isEmpty(result.detectedPeople)}"
                         style="text-align: center; padding: 40px; color: #666;">
                        No people detected in this media.
                    </div>
                    <div th:each="person : ${result.detectedPeople}" class="data-item">
                        <div class="data-row">
                            <span class="data-label">ID:</span>
                            <span class="data-value" th:text="${person.uniqueId}">unique-id</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Age Category:</span>
                            <span class="badge"
                                  th:classappend="${person.ageCategory == 'CHILD'} ? 'badge-child' : 'badge-adult'"
                                  th:text="${person.ageCategory}">ADULT</span>
                        </div>
                        <div class="data-row" th:if="${person.estimatedAge != null}">
                            <span class="data-label">Estimated Age:</span>
                            <span class="data-value" th:text="${person.estimatedAge}">30</span>
                        </div>
                        <div class="data-row" th:if="${person.emotionalState != null}">
                            <span class="data-label">Emotion:</span>
                            <span class="data-value" th:text="${person.emotionalState}">HAPPY</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Confidence:</span>
                            <span class="badge"
                                  th:classappend="${person.confidence >= 0.8} ? 'badge-high' : 'badge-medium'"
                                  th:text="${#numbers.formatDecimal(person.confidence * 100, 1, 2)} + '%'">95%</span>
                        </div>
                        <div class="data-row" th:if="${person.timestamp != null}">
                            <span class="data-label">Time:</span>
                            <span class="timestamp"
                                  th:text="${#numbers.formatDecimal(person.timestamp, 1, 2)} + 's'">12.5s</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="objects" class="tab-content">
                <div class="data-list">
                    <div th:if="${#lists.isEmpty(result.detectedObjects)}"
                         style="text-align: center; padding: 40px; color: #666;">
                        No objects detected in this media.
                    </div>
                    <div th:each="object : ${result.detectedObjects}" class="data-item">
                        <div class="data-row">
                            <span class="data-label">Object:</span>
                            <span class="data-value" th:text="${object.objectName}">Coffee Cup</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Category:</span>
                            <span class="data-value" th:text="${object.category}">BEVERAGE</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Confidence:</span>
                            <span class="badge"
                                  th:classappend="${object.confidence >= 0.8} ? 'badge-high' : 'badge-medium'"
                                  th:text="${#numbers.formatDecimal(object.confidence * 100, 1, 2)} + '%'">92%</span>
                        </div>
                        <div class="data-row" th:if="${object.timestamp != null}">
                            <span class="data-label">Time:</span>
                            <span class="timestamp"
                                  th:text="${#numbers.formatDecimal(object.timestamp, 1, 2)} + 's'">15.3s</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="books" class="tab-content">
                <div class="data-list">
                    <div th:if="${#lists.isEmpty(result.detectedBooks)}"
                         style="text-align: center; padding: 40px; color: #666;">
                        No books detected in this media.
                    </div>
                    <div th:each="book : ${result.detectedBooks}" class="data-item">
                        <div class="data-row">
                            <span class="data-label">Title:</span>
                            <span class="data-value" th:text="${book.bookName}">Book Title</span>
                        </div>
                        <div class="data-row" th:if="${book.author != null}">
                            <span class="data-label">Author:</span>
                            <span class="data-value" th:text="${book.author}">Author Name</span>
                        </div>
                        <div class="data-row" th:if="${book.isbn != null}">
                            <span class="data-label">ISBN:</span>
                            <span class="data-value" th:text="${book.isbn}">1234567890</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Unique ID:</span>
                            <span class="data-value" th:text="${book.uniqueId}">unique-id</span>
                        </div>
                        <div class="data-row">
                            <span class="data-label">Confidence:</span>
                            <span class="badge"
                                  th:classappend="${book.confidence >= 0.8} ? 'badge-high' : 'badge-medium'"
                                  th:text="${#numbers.formatDecimal(book.confidence * 100, 1, 2)} + '%'">85%</span>
                        </div>
                        <div class="data-row" th:if="${book.timestamp != null}">
                            <span class="data-label">Time:</span>
                            <span class="timestamp"
                                  th:text="${#numbers.formatDecimal(book.timestamp, 1, 2)} + 's'">8.7s</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const mediaFileId = /*[[${result.mediaFileId}]]*/ 0;

    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        event.target.classList.add('active');
    }

    async function processQuery() {
        const queryInput = document.getElementById('queryInput');
        const queryResult = document.getElementById('queryResult');
        const query = queryInput.value.trim();

        if (!query) {
            alert('Please enter a question');
            return;
        }

        queryResult.innerHTML = '<p>Searching...</p>';
        queryResult.classList.add('show');

        try {
            const response = await fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    mediaFileId: mediaFileId,
                    query: query
                })
            });

            const data = await response.json();
            displayQueryResult(data);
        } catch (error) {
            queryResult.innerHTML = '<p style="color: red;">Error processing query</p>';
        }
    }

    function displayQueryResult(data) {
        const queryResult = document.getElementById('queryResult');

        let html = '<h4>üéØ ' + data.answer + '</h4>';

        if (data.matches && data.matches.length > 0) {
            html += '<div style="margin-top: 15px;">';
            html += '<strong>Matches:</strong><br>';
            data.matches.forEach(match => {
                html += '<div style="padding: 8px; background: #f0f1ff; margin: 5px 0; border-radius: 5px;">';
                html += '<strong>' + match.type + ':</strong> ' + match.description;
                if (match.timestamp) {
                    html += ' <span style="color: #764ba2; font-weight: bold;">@ ' +
                            match.timestamp.toFixed(2) + 's</span>';
                }
                html += ' <span style="color: #666;">(' + (match.confidence * 100).toFixed(0) + '% confidence)</span>';
                html += '</div>';
            });
            html += '</div>';
        }

        queryResult.innerHTML = html;
    }

    // Allow Enter key to submit query
    document.getElementById('queryInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            processQuery();
        }
    });
    /*]]>*/
</script>
</body>
</html>